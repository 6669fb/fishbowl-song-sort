<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>fishbowl 楽曲ソート</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: system-ui, sans-serif; margin:0; background:#f4f4f4; }
header { padding:14px; text-align:center; font-weight:bold; background:#fff; border-bottom:1px solid #ddd; }
main { padding:16px; }
h2 { font-size:16px; margin-bottom:8px; }
.info { font-size:13px; color:#555; margin:6px 0 12px; }
.list { display:flex; flex-direction:column; gap:8px; }
.item { background:#fff; padding:14px; border-radius:12px; text-align:center; border:1px solid #ddd; cursor:pointer; }
.draw-item { padding:10px; font-size:13px; }
button { width:100%; padding:14px; border-radius:12px; border:none; background:#111827; color:#fff; font-size:14px; margin-top:10px; }
.hidden { display:none; }
.result-box { background:#fff; border-radius:16px; padding:16px; max-height:80vh; overflow-y:auto; }
.notice { font-size:12px; color:#555; margin-top:10px; text-align:center; }
</style>
</head>

<body>
<header>fishbowl 楽曲ソート</header>

<main>

<section id="mode">
  <button onclick="startTop15()">上位15曲ソート</button>
  <p class="info">15曲を選択後、比較しながら順位を決めます。</p>

  <button onclick="startAll()">全曲ソートモード</button>
  <p class="info">全曲を比較して順位を決めます。</p>

  <button id="resumeBtn" onclick="loadAll()">全曲ソートを再開</button>
  <button onclick="clearSave()">セーブデータ削除</button>
</section>

<section id="select15" class="hidden">
  <h2>上位15曲を選択</h2>
  <div class="info">選択数：<span id="selCount">0</span> / 15</div>
  <div class="list" id="selectList"></div>
</section>

<section id="confirm15" class="hidden">
  <h2>確認</h2>
  <ol id="confirmList"></ol>
  <button onclick="proceed15()">進む</button>
  <button onclick="backToSelect15()">戻る（選択は保持されています）</button>
</section>

<section id="rank15" class="hidden">
  <h2>上位15曲ソート</h2>
  <div class="info">進捗：<span id="prog15">0</span>%</div>

  <div class="list">
    <div class="item" id="a15" onclick="pick15(0)"></div>
    <div class="item draw-item" onclick="draw15()">引き分け</div>
    <div class="item" id="b15" onclick="pick15(1)"></div>
  </div>

  <button id="backMode15" onclick="backToMode()">モード選択に戻る</button>
</section>

<section id="result15" class="hidden">
  <div class="result-box">
    <h3>fishbowl 楽曲ソート結果（上位15）</h3>
    <ol id="result15List"></ol>
    <p class="notice">
      全順位を投稿したい場合、スクリーンショットを添付してください。
    </p>
  </div>
  <button onclick="tweetTop15()">Xに投稿（上位5）</button>
</section>

<section id="allSort" class="hidden">
  <h2>全曲ソート</h2>
  <div class="info">進捗：<span id="prog">0</span>%</div>

  <div class="list">
    <div class="item" id="a" onclick="pick(0)"></div>
    <div class="item draw-item" onclick="draw()">引き分け</div>
    <div class="item" id="b" onclick="pick(1)"></div>
  </div>

  <button onclick="undo()">戻る</button>
  <button onclick="saveAll()">途中セーブ</button>
  <button id="backModeAll" onclick="backToMode()">モード選択に戻る</button>
</section>

<section id="allResult" class="hidden">
  <div class="result-box">
    <h3>fishbowl 楽曲ソート結果（全曲）</h3>
    <ol id="allResultList"></ol>
    <p class="notice">
      全順位を投稿したい場合、スクリーンショットを添付てください。
    </p>
  </div>
  <button onclick="tweetAll()">Xに投稿（上位10）</button>
</section>

</main>

<script>
const SAVE_KEY = "fishbowl_all_sort";
const songs = [
"生活","最百","舞踏","蒼霞","愛味","斜陽","熱波(new ver.)","しずおか35市町おぼえてる？",
"ちょこっとLOVE","三島","四季","一雨","二兎","±零 yaya plus","±零 yaya minus",
"九天","十色","七夕","八月","五五","六感","アイラブユー",
"湖月","表裏","茶切 dope side","半分","茶切 cute side","完食","白線","熱波",
"開幕","風花","尻尾","バレンタインデー","距離","観察","猛獣","雪景","夜桜","踊子"
];

function backToMode(){ location.reload(); }
function updateResumeBtn(){ resumeBtn.classList.toggle("hidden", !localStorage.getItem(SAVE_KEY)); }
updateResumeBtn();

/* ===== 上位15 ===== */
let selected=[], top15Arr=[], i15=0,j15=1,c15=0, first15=true;

function backToSelect15(){
  confirm15.classList.add("hidden");
  select15.classList.remove("hidden");
  renderSelect15();
}

function startTop15(){
  mode.classList.add("hidden");
  select15.classList.remove("hidden");
  renderSelect15();
}

function renderSelect15(){
  selectList.innerHTML="";
  selCount.textContent=selected.length;
  songs.forEach(s=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=s;
    if(selected.includes(s)) d.style.background="#dbeafe";
    d.onclick=()=>{
      if(selected.includes(s)) selected=selected.filter(x=>x!==s);
      else if(selected.length<15) selected.push(s);
      renderSelect15();
      if(selected.length===15){
        select15.classList.add("hidden");
        showConfirm15();
      }
    };
    selectList.appendChild(d);
  });
}

function showConfirm15(){
  confirm15.classList.remove("hidden");
  confirmList.innerHTML="";
  selected.forEach(s=>{
    const li=document.createElement("li");
    li.textContent=s;
    confirmList.appendChild(li);
  });
}

function proceed15(){
  confirm15.classList.add("hidden");
  rank15.classList.remove("hidden");
  top15Arr=[...selected];
  i15=0;j15=1;c15=0; first15=true;
  backMode15.classList.remove("hidden");
  show15();
}

function show15(){
  a15.textContent=top15Arr[i15];
  b15.textContent=top15Arr[j15];
  prog15.textContent=Math.floor(c15/(15*14/2)*100);
}

function next15(){
  c15++; j15++;
  if(first15){ backMode15.classList.add("hidden"); first15=false; }
  if(j15>=15){ i15++; j15=i15+1; }
  if(i15>=14){ showResult15(); return; }
  show15();
}

function pick15(w){ if(w===0)[top15Arr[i15],top15Arr[j15]]=[top15Arr[j15],top15Arr[i15]]; next15(); }
function draw15(){ next15(); }

/* ===== 全曲 ===== */
let arr=[], stack=[], i=0,j=1,cmp=0, firstAll=true;

function startAll(){
  mode.classList.add("hidden");
  allSort.classList.remove("hidden");
  arr=[...songs]; stack=[]; i=0;j=1;cmp=0; firstAll=true;
  backModeAll.classList.remove("hidden");
  show();
}

function show(){
  a.textContent=arr[i];
  b.textContent=arr[j];
  prog.textContent=Math.floor(cmp/(songs.length*(songs.length-1)/2)*100);
}

function next(){
  cmp++; j++;
  if(firstAll){ backModeAll.classList.add("hidden"); firstAll=false; }
  if(j>=arr.length){ i++; j=i+1; }
  if(i>=arr.length-1){ showAllResult(); return; }
  show();
}

function pick(w){
  stack.push({arr:[...arr],i,j,cmp});
  if(w===0)[arr[i],arr[j]]=[arr[j],arr[i]];
  next();
}
function draw(){
  stack.push({arr:[...arr],i,j,cmp});
  next();
}

function undo(){
  if(!stack.length){ alert("これ以上戻れません"); return; }
  const prev=stack.pop();
  ({arr,i,j,cmp}=prev);
  show();
}

/* ===== セーブ ===== */
function saveAll(){
  localStorage.setItem(SAVE_KEY, JSON.stringify({arr,stack,i,j,cmp}));
  updateResumeBtn();
  alert("途中セーブしました");
}

function loadAll(){
  const raw=localStorage.getItem(SAVE_KEY);
  if(!raw){ alert("セーブデータがありません"); return; }
  ({arr,stack,i,j,cmp}=JSON.parse(raw));
  mode.classList.add("hidden");
  allSort.classList.remove("hidden");
  firstAll=false;
  backModeAll.classList.add("hidden");
  show();
}

/* ===== X投稿 ===== */
const URL_TEXT = "ソートしたい場合はこちらから→https://6669fb.github.io/fishbowl-song-sort/";

function tweetTop15(){
  let t = "#fishbowl 楽曲ソート（上位15曲モード） 上位5曲\n";
  top15Arr.slice(0,5).forEach((s,i)=>{ t += `${i+1}位 ${s}\n`; });
  window.open("https://twitter.com/intent/tweet?text=" + encodeURIComponent(t + "\n" + URL_TEXT));
}

function tweetAll(){
  let t = "#fishbowl 楽曲ソート（全楽曲モード） 上位10曲\n";
  arr.slice(0,10).forEach((s,i)=>{ t += `${i+1}位 ${s}\n`; });
  window.open("https://twitter.com/intent/tweet?text=" + encodeURIComponent(t + "\n" + URL_TEXT));
}
</script>
</body>
</html>
